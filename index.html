<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Pointcloud Viewer</title>
    <style>
      body {margin:0; padding:0; background-color:#000000}
      canvas {width:100%; height:100%;}
    </style>

    <script src="js/three.min.js"></script>
  </head>

  <body>

    <div id="container" style="width:100%; height:100%; position:relative;"> </div>

        <script>

            // Scene
            var scene = new THREE.Scene();

            // Camera
            var camera = new THREE.PerspectiveCamera(15, window.innerWidth / window.innerHeight, 0.5, 1000);
            camera.position.z = -5;
            //camera.position.y = 1;
            //camera.position.x = -1;

            // The renderer
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth,window.innerHeight -4);

            // Render the scene
            function render() {
                renderer.render(scene, camera);
            }

            // Setup controls
            var controls = new THREE.TrackballControls(camera);
            controls.rotateSpeed = 1.0;
            controls.zoomSpeed = 10.2;
            controls.panSpeed = 10;
            controls.noZoom = false;
            controls.noPan = false;
            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;
            controls.keys = [65, 17, 18];
            controls.addEventListener('change', render);

            // Render loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
            }

            // Build the scene
            var pointSize = 0.05;

            function buildScene(geometry, material) {
                // Re-render the scene
                material = new THREE.ParticleBasicMaterial({ size: pointSize, vertexColors: true });
                var pointcloud = new THREE.ParticleSystem(geometry, material);
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.0009);
                scene.add(pointcloud);
                render();
            }

            var container = document.getElementById('container');
            container.appendChild(renderer.domElement);

            var ws = new WebSocket("ws://127.0.0.1:5678/")
            ws.onmessage = function (event) {
                    points = JSON.parse(event.data);

                    var geometry = new THREE.Geometry({dynamic:true});
                    var material = new THREE.ParticleBasicMaterial({size:pointSize, vertexColors:true});
                    var colors = [];
                    for(var i = 0; i < points.length; i++) {
                        var point = points[i];
                        var x = point[0];
                        var y = point[1];
                        var z = point[2];
                        geometry.vertices.push(new THREE.Vector3(x, y, z));
                        var r = point[3];
                        var g = point[4];
                        var b = point[5];
                        var rgb = b | (g << 8) | (r << 16);
                        var rgb_str = '0x' + rgb.toString(16);
                        colors.push(new THREE.Color(rgb_str));
                    }
                    geometry.colors = colors;
                    buildScene(geometry, material)
            };

            render();
            animate();

        </script>

    </body>
</html>
