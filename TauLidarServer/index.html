<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Tau Pointcloud Viewer</title>
    <style>
      body {margin:0; padding:0; background-color:#000000}
      canvas {width:100%; height:100%;}
    </style>

  </head>

  <body>

    <div id="container" style="width:100%; height:100%; position:relative;"> </div>

        <script type="module" id='app'>
            import * as THREE from 'https://unpkg.com/three/build/three.module.js';
            import { OrbitControls } from 'https://unpkg.com/three/examples/jsm/controls/OrbitControls.js';


            // Scene
            var scene = new THREE.Scene();
            // scene.background = new THREE.Color( '#222f3e' );

            // Camera
            var camera = new THREE.PerspectiveCamera(15, window.innerWidth / window.innerHeight, 1, 1000);
            // camera.position.z = 200;
            camera.position.set(0, 0, -5);

            // The renderer
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth,window.innerHeight -4);

            // Render the scene
            function render() {
                renderer.render(scene, camera);
            }


            // Setup controls
            var controls = new OrbitControls(camera, renderer.domElement);
            // controls.autoRotate = true;
            controls.addEventListener('change', render);


            // Render loop
            function animate() {
                requestAnimationFrame( animate );
                controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true
                render();
            }

            // Build the scene
            var pointSize = 0.05;

            var pointcloud;
            function buildScene(geometry, material) {
                // Re-render the scene
                pointcloud = new THREE.Points(geometry, material);

                scene.children.forEach(c => {
                    scene.remove(c)
                });

                scene.add(pointcloud);
                render();
            }

            var container = document.getElementById('container');
            container.appendChild(renderer.domElement);

            var material = new THREE.PointsMaterial({size:pointSize, vertexColors:true});

            var ws = new WebSocket("ws://127.0.0.1:5678/")
            ws.onmessage = function (event) {
                    var points = JSON.parse(event.data);

                    var geometry = new THREE.Geometry({dynamic:true});

                    var colors = [];
                    for(var i = 0; i < points.length; i++) {
                        var point = points[i];
                        var x = point[0];
                        var y = point[1];
                        var z = point[2];
                        geometry.vertices.push(new THREE.Vector3(x, y, z));
                        var r = point[3];
                        var g = point[4];
                        var b = point[5];
                        var rgb_str = `rgb(${r}, ${g}, ${b})`
                        colors.push(new THREE.Color(rgb_str));
                    }
                    geometry.colors = colors;
                    buildScene(geometry, material)
            };

            render();
            animate();
            document.material = material
            document.controls = controls
            console.log(controls);
            console.log(scene);
            console.log(camera);

        </script>

    </body>
</html>
